// var imagePath = '../../../../../../Users/gabrielbach/Desktop/Salemoche/Freelance/Possa/InDesign_Scripting/Test/Test_Daten/Probesatz/Bilder/180319/'

var data = 
[
    {
      "Profil_": "SP",
      "Position_": "1",
      "Datum_": "3/18/2019",
      "Uhrzeit_": "13:45",
      "Thema_": "Kantonsrat",
      "Gesinnung_": "Links",
      "Verl�sslichkeit_": "Reisserisch",
      "Art_": "Partei",
      "Aufbau_": "Post-Artikel",
      "Medium_": "Text-Bild",
      "Bodytext_": "*pn*Gr�ne Z�rich*/pn*\n\n*pd*18.03.19*/pd*\n\n*pb*�Vor ihm haben unsere Eltern uns immer gewarnt�, schreibt der�Tages-Anzeiger��ber unseren Kantonsrat R�bi Brunner!�Rafa Ella Roth�vom startet ihren neuen Tagi-Videotalk �Hobbyruum�.�#Klimawahl2019*/pb*\n\n*ab*Tagesanzeiger*/ab*\n\n*ad*15.03.19*/ad*\n\n*aa*Rafaela Roth*/aa*\n\n*at*Vor ihm haben unsere Eltern uns immer gewarnt*/at*\n\n*al*Rafaela Roth trifft auf den Charmebolzen der Gr�nen: Robert �R�bi� Brunner. Start des Tagi-Videotalks �Hobbyruum�.*/al*\n\n*ab*Am 24. M�rz w�hlt der Kanton Z�rich eine neue Regierung. Bis dahin schnappt sich die Z�ri-Redaktorin Rafaela Roth ein paar potenzielle Kandidierende f�r eine kleine Bastel-Challenge. Dies ist der neue �Hobbyruum�, ein Videotalk, in welchem wir nicht nur �ber Politik sprechen, aber auch. Sehen Sie jetzt Folge 1 - heute mit dem Kantonsrat der Gr�nen: Robert �R�bi� Brunner.*/ab*",
      "LinkText_": "https://www.tagesanzeiger.ch/zuerich/region/vor-ihm-haben-unsere-eltern-uns-immer-gewarnt/story/29250246?fbclid=%20a-W0xm7rwdCcTAy96QSjQgLH5-QDSB0",
      "LinkBild_": "DS_A_26-03-19",
      "Bildunterschriften_": "Robert Brunners Lieblingsdroge?: �Rotwein! Drogen machen eine weiche Birne.�.Video: Lea Blum, Sarah Fluck"
    },
    {
      "Profil_": "DD",
      "Position_": "2",
      "Datum_": "3/18/2019",
      "Uhrzeit_": "16:04",
      "Thema_": "Demonstration",
      "Gesinnung_": "Rechts",
      "Verl�sslichkeit_": "Reisserisch",
      "Art_": "Privat Person",
      "Aufbau_": "Re-Post-Artikel",
      "Medium_": "Text-Bild",
      "Bodytext_": "*pn*Erich Hess*/pn*\n\n*pd*18.03.2019*/pd*\n\n*pt*Das ist typisch f�r den rot - gr�nen Filz in der Stadt Bern!*/pt*\n\n*rn*TeleB�rn*/rn*\n\n*rd*18.03.2019*/rd*\n\n*rt*Klima-Aktivisten d�rfen trotz Kundgebungs-Verbot demonstrieren:*/rt*\n\n*an*TeleB�rn News*/an*\n\n*ad*17.03.2019*/ad*\n\n*at*�Eine absolute Sauerei!� Erich Hess �rgert sich �ber Kundgebungs-Erlaubnis der Klima-Aktivisten*/at*\n\n*ab* Grunds�tzlich gilt zwei Wochen vor den eidgen�ssischen Wahlen ein Kundgebungs-Verbot. Klimaschutz-Aktivisten planen jedoch kurz vorher erneut eine Demo � und das sogar mit Erlaubnis. */ab*",
      "LinkText_": "https://www.telebaern.tv/telebaern-news/eine-absolute-sauerei-erich-hess-aergert-sich-ueber-kundgebungs-erlaubnis-der-klima-aktivisten-134221166?utm_source=shared-twitter&fbclid=IwAR2DMQycuNK_OiDkvaLpp2KcAg2gwONaauP0IR5cthGdnTE8k8lSELatxvU",
      "LinkBild_": "Bildschirmfoto 2019-03-18 um 15.05.09",
      "Bildunterschriften_": ""
    },
    {
        "Profil_": "SP",
        "Position_": "3",
        "Datum_": "3/18/2019",
        "Uhrzeit_": "13:45",
        "Thema_": "Kantonsrat",
        "Gesinnung_": "Links",
        "Verl�sslichkeit_": "Reisserisch",
        "Art_": "Partei",
        "Aufbau_": "Post-Artikel",
        "Medium_": "Text-Bild",
        "Bodytext_": "*pn*Gr�ne Z�rich*/pn*\n\n*pd*18.03.19*/pd*\n\n*pb*�Vor ihm haben unsere Eltern uns immer gewarnt�, schreibt der�Tages-Anzeiger��ber unseren Kantonsrat R�bi Brunner!�Rafa Ella Roth�vom startet ihren neuen Tagi-Videotalk �Hobbyruum�.�#Klimawahl2019*/pb*\n\n*ab*Tagesanzeiger*/ab*\n\n*ad*15.03.19*/ad*\n\n*aa*Rafaela Roth*/aa*\n\n*at*Vor ihm haben unsere Eltern uns immer gewarnt*/at*\n\n*al*Rafaela Roth trifft auf den Charmebolzen der Gr�nen: Robert �R�bi� Brunner. Start des Tagi-Videotalks �Hobbyruum�.*/al*\n\n*ab*Am 24. M�rz w�hlt der Kanton Z�rich eine neue Regierung. Bis dahin schnappt sich die Z�ri-Redaktorin Rafaela Roth ein paar potenzielle Kandidierende f�r eine kleine Bastel-Challenge. Dies ist der neue �Hobbyruum�, ein Videotalk, in welchem wir nicht nur �ber Politik sprechen, aber auch. Sehen Sie jetzt Folge 1 - heute mit dem Kantonsrat der Gr�nen: Robert �R�bi� Brunner.*/ab*",
        "LinkText_": "https://www.tagesanzeiger.ch/zuerich/region/vor-ihm-haben-unsere-eltern-uns-immer-gewarnt/story/29250246?fbclid=%20a-W0xm7rwdCcTAy96QSjQgLH5-QDSB0",
        "LinkBild_": "Bildschirmfoto 2019-03-18 um 14.04.07",
        "Bildunterschriften_": "Robert Brunners Lieblingsdroge?: �Rotwein! Drogen machen eine weiche Birne.�.Video: Lea Blum, Sarah Fluck"
    },
    {
      "Profil_": "DD",
      "Position_": "4",
      "Datum_": "3/18/2019",
      "Uhrzeit_": "16:04",
      "Thema_": "Demonstration",
      "Gesinnung_": "Rechts",
      "Verl�sslichkeit_": "Reisserisch",
      "Art_": "Privat Person",
      "Aufbau_": "Re-Post-Artikel",
      "Medium_": "Text-Bild",
      "Bodytext_": "*pn*Erich Hess*/pn*\n\n*pd*18.03.2019*/pd*\n\n*pt*Das ist typisch f�r den rot - gr�nen Filz in der Stadt Bern!*/pt*\n\n*rn*TeleB�rn*/rn*\n\n*rd*18.03.2019*/rd*\n\n*rt*Klima-Aktivisten d�rfen trotz Kundgebungs-Verbot demonstrieren:*/rt*\n\n*an*TeleB�rn News*/an*\n\n*ad*17.03.2019*/ad*\n\n*at*�Eine absolute Sauerei!� Erich Hess �rgert sich �ber Kundgebungs-Erlaubnis der Klima-Aktivisten*/at*\n\n*ab* Grunds�tzlich gilt zwei Wochen vor den eidgen�ssischen Wahlen ein Kundgebungs-Verbot. Klimaschutz-Aktivisten planen jedoch kurz vorher erneut eine Demo � und das sogar mit Erlaubnis. */ab*",
      "LinkText_": "https://www.telebaern.tv/telebaern-news/eine-absolute-sauerei-erich-hess-aergert-sich-ueber-kundgebungs-erlaubnis-der-klima-aktivisten-134221166?utm_source=shared-twitter&fbclid=IwAR2DMQycuNK_OiDkvaLpp2KcAg2gwONaauP0IR5cthGdnTE8k8lSELatxvU",
      "LinkBild_": "Bildschirmfoto 2019-03-18 um 15.05.09",
      "Bildunterschriften_": ""
    },
    {
      "Profil_": "DD",
      "Position_": "5",
      "Datum_": "3/18/2019",
      "Uhrzeit_": "16:04",
      "Thema_": "Demonstration",
      "Gesinnung_": "Rechts",
      "Verl�sslichkeit_": "Reisserisch",
      "Art_": "Privat Person",
      "Aufbau_": "Re-Post-Artikel",
      "Medium_": "Text-Bild",
      "Bodytext_": "*pn*Erich Hess*/pn*\n\n*pd*18.03.2019*/pd*\n\n*pt*Das ist typisch f�r den rot - gr�nen Filz in der Stadt Bern!*/pt*\n\n*rn*TeleB�rn*/rn*\n\n*rd*18.03.2019*/rd*\n\n*rt*Klima-Aktivisten d�rfen trotz Kundgebungs-Verbot demonstrieren:*/rt*\n\n*an*TeleB�rn News*/an*\n\n*ad*17.03.2019*/ad*\n\n*at*�Eine absolute Sauerei!� Erich Hess �rgert sich �ber Kundgebungs-Erlaubnis der Klima-Aktivisten*/at*\n\n*ab* Grunds�tzlich gilt zwei Wochen vor den eidgen�ssischen Wahlen ein Kundgebungs-Verbot. Klimaschutz-Aktivisten planen jedoch kurz vorher erneut eine Demo � und das sogar mit Erlaubnis. */ab*",
      "LinkText_": "https://www.telebaern.tv/telebaern-news/eine-absolute-sauerei-erich-hess-aergert-sich-ueber-kundgebungs-erlaubnis-der-klima-aktivisten-134221166?utm_source=shared-twitter&fbclid=IwAR2DMQycuNK_OiDkvaLpp2KcAg2gwONaauP0IR5cthGdnTE8k8lSELatxvU",
      "LinkBild_": "Bildschirmfoto 2019-03-18 um 15.05.09",
      "Bildunterschriften_": ""
    }
]

var doc = app.documents.item(0);
var page = doc.pages.item(0);
var pageWidth = page.bounds[3] -  page.bounds[1];
var pageHeight = page.bounds[2] -  page.bounds[0];
var allGroups = [];
var lastPage = 0;
var leftPage = lastPage % 2 == 0;
var borderLeft = leftPage ? 8 : 18;
var borderRight = leftPage ? 18 : 8;
var borderTopBottom = 18;
var wholeLength = 0;
var numberOfIterations = 1;
// var numberOfIterations = data.length;
var imagePath = './img/'

// for (var i = 0; i < numberOfIterations; i++) {
//     var newGroup = addGroup(i);
//     allGroups.push(newGroup);

//     wholeLength += getElement(newGroup).height;


//     if (allGroups[i-1]) {

//         var marginTop = 4;

//         positionElement(newGroup, 0, getElement(allGroups[i-1]).y2 + marginTop, 0, 0);

//         if(wholeLength >= pageHeight * (lastPage + 1) + marginTop) {
//             doc.pages.add();
//             lastPage ++;
//             newGroup.move(doc.pages[lastPage])
//         }
        
//     }

// }

doc.pages.add();
lastPage ++;

for (var i = 0; i < numberOfIterations; i++) {

    addImage(i);    
}


function addGroup(index) {

    var itemsToGroup = new Array();  
    var id = '#' + index;

    // ===============
    // Profil
    // ===============

    var tb_profil = createTextbox('tb_profil', id, 'PROFIL ' + data[index].Profil_, itemsToGroup);
    tb_profil.paragraphs[0].pointSize = 18;
    positionElement(tb_profil, 0, 0, 0, 0);
    setDimensions(tb_profil, pageWidth/2, null, 0, 0);

    // ===============
    // Position
    // ===============

    var tb_position = createTextbox('tb_position', id, 'POSITION  ' + data[index].Position_, itemsToGroup);
    tb_position.paragraphs[0].pointSize = 18;
    positionElement(tb_position, pageWidth / 2, 0, 0, 0);
    setDimensions(tb_position, pageWidth/2, null, 0, 0);

    // ===============
    // Uhrzeit
    // ===============

    var tb_uhrzeit = createTextbox('tb_uhrzeit', id, data[index].Uhrzeit_, itemsToGroup);
    tb_uhrzeit.paragraphs[0].pointSize = 9;
    positionElement(tb_uhrzeit,  pageWidth/5 * 0, getElement(tb_profil).y2, 0, 0);
    setDimensions(tb_uhrzeit, pageWidth/5, null, 0, 0);

    // ===============
    // Aufbau
    // ===============

    var tb_aufbau = createTextbox('tb_aufbau', id, data[index].Aufbau_, itemsToGroup);
    positionElement(tb_aufbau, pageWidth/5 * 1, getElement(tb_profil).y2, 0, 0);
    setDimensions(tb_aufbau, pageWidth/5, null, 0, 0);

    // ===============
    // Medium
    // ===============

    var tb_medium = createTextbox('tb_medium', id, data[index].Medium_, itemsToGroup);
    positionElement(tb_medium, pageWidth/5 * 2, getElement(tb_profil).y2, 0, 0);
    setDimensions(tb_medium, pageWidth/5, null, 0, 0);

    // ===============
    // Art
    // ===============

    var tb_art = createTextbox('tb_art', id, data[index].Art_, itemsToGroup);
    positionElement(tb_art, pageWidth/5 * 3, getElement(tb_profil).y2, 0, 0);
    setDimensions(tb_art, pageWidth/5, null, 0, 0);

    // ===============
    // Datum
    // ===============

    // var tb_datum = page.textFrames.add();
    // tb_datum.name = 'element_' + id + '_textbox_datum' 
    // tb_datum.contents = data[index].Datum_;
    // positionElement(tb_datum, 0, getElement(tb_uhrzeit).y2, 0, 0);
    // setDimensions(tb_datum, pageWidth/3, null);
    // itemsToGroup.push(tb_datum);

    // ===============
    // Body Text
    // ===============

    var fullText = data[index].Bodytext_;
    var postName = getText(fullText, 'pn');
    var postDatum = getText(fullText, 'pd');
    var postBodyText = getText(fullText, 'pb');
    var repostName = getText(fullText, 'rn');
    var repostDatum = getText(fullText, 'rd');
    var repostBodyText = getText(fullText, 'rb');
    var artikelName = getText(fullText, 'an');
    var artikelDatum = getText(fullText, 'ad');
    var artikelAutor = getText(fullText, 'aa');
    var artikelTitel = getText(fullText, 'at');
    var artikelLead = getText(fullText, 'al');
    var artikelUntertitel = getText(fullText, 'au');
    var artikelBodytext = getText(fullText, 'ab');


    var tb_text_postDatum = createTextbox('tb_text_postDatum', id, postDatum, itemsToGroup);
    positionElement(tb_text_postDatum, 0, getElement(tb_art).y2, 0, 0);
    setDimensions(tb_text_postDatum, pageWidth/3, null, 0, 0);

    var tb_text_postName = createTextbox('tb_text_postName', id, postName, itemsToGroup);
    positionElement(tb_text_postName, pageWidth/3 * 1, getElement(tb_art).y2, 0, 0);
    setDimensions(tb_text_postName, pageWidth/3, null, 0, 0);

    var tb_text_postBodyText = createTextbox('tb_text_postBodyText', id, postBodyText, itemsToGroup);
    tb_text_postBodyText.paragraphs[0].pointSize = 24;
    tb_text_postBodyText.paragraphs[0].appliedFont = app.fonts.item("Neue Haas Unica Pro");
    tb_text_postBodyText.paragraphs[0].fontStyle = "Black";
    positionElement(tb_text_postBodyText, 0, getElement(tb_text_postName).y2, 0, 0);
    setDimensions(tb_text_postBodyText, pageWidth, null, 0, 2);

    var tb_text_artikelDatum = createTextbox('tb_text_artikelDatum', id, artikelDatum, itemsToGroup);
    positionElement(tb_text_artikelDatum, pageWidth/5, getElement(tb_text_postBodyText).y2, 0, 0);
    setDimensions(tb_text_artikelDatum, pageWidth/5, null, 0, 0);

    var tb_text_artikelBodytext = createTextbox('tb_text_artikelBodytext', id, artikelBodytext, itemsToGroup);
    positionElement(tb_text_artikelBodytext, pageWidth/5 * 2, getElement(tb_text_postBodyText).y2, 0, 0);
    setDimensions(tb_text_artikelBodytext, pageWidth/5*3, null, 0, 0);


    // var tb_linkBild = page.textFrames.add();
    // tb_linkBild.contents = data[index].LinkBild_;

    // var tb_bildUnterschriften = page.textFrames.add();
    // tb_bildUnterschriften.contents = data[index].Bildunterschriften_;


    var myGroup = app.documents[0].groups.add(itemsToGroup);  
    myGroup.name = 'element_' + id;
    

    return myGroup;
}

function addImage(index) {
        
    // ===============
    // Image
    // ===============

    var image = doc.pages.item(lastPage).textFrames.add();
    // image.contents = data[index].LinkBild_ || 'unknown';
    // image.name = 'element_' + id + '_textbox_' * element;
    

    image.place (File(app.activeDocument.filePath + '/img/' + data[index].LinkBild_ + '.jpg'), false);
    // image.recompose();
    image.fit(FitOptions.frameToContent);
    // image.fit (FitOptions.CONTENT_TO_FRAME);
    // image.fit (FitOptions.PROPORTIONALLY);
    // image.fit (FitOptions.CENTER_CONTENT);
    // image.recompose();
    // image.fit(FitOptions.frameToContent);

    positionElement(image, 2, 2, 0, 0);
    setDimensions(image, null, 10, 0, 0);

    var text = doc.pages.item(lastPage).textFrames.add();
    text.contents = data[index].Bildunterschriften_ || 'unknown';
    text.recompose();
    text.fit(FitOptions.frameToContent);
    positionElement(image, 2, getElement(image).y2, 0, 0);
}

function createTextbox(element, id, content, array) {

    var item = doc.pages.item(lastPage).textFrames.add();
    item.contents = content || 'unknown';
    item.recompose();
    item.fit(FitOptions.frameToContent);
    item.name = 'element_' + id + '_textbox_' * element;
    array.push(item);

    var text = item.paragraphs[0];
    text.appliedFont = app.fonts.item("Nimbus Roman Mono M");
    text.fontStyle = "Regular";

    return item;
}


function positionElement(element, x, y, marginLeft, marginTop) {
    // element.recompose();
    element.fit(FitOptions.frameToContent);
    
    var elementWidth = element.geometricBounds[3] -  element.geometricBounds[1];
    var elementHeight = element.geometricBounds[2] -  element.geometricBounds[0];

    element.geometricBounds = [y, x, marginTop + y + elementHeight, marginLeft + x + elementWidth];

}

function getElement(element) {

    var item = {
        x: element.geometricBounds[1],
        y: element.geometricBounds[0],
        x2: element.geometricBounds[3],
        y2: element.geometricBounds[2],
        width: element.geometricBounds[3] -  element.geometricBounds[1],
        height: nameHeight = element.geometricBounds[2] -  element.geometricBounds[0],
    }

    return item;
}

function setDimensions(element, width, height, spacingRight, spacingBottom) {

    var dimensions = element.geometricBounds;

    if (width) {
        element.geometricBounds = [dimensions[0], dimensions[1], dimensions[2], dimensions[1] + width];
    }

    dimensions = element.geometricBounds;

    if (spacingRight) {
        element.geometricBounds = [dimensions[0], dimensions[1], dimensions[2], dimensions[1] + spacingRight];
    }

    element.fit(FitOptions.frameToContent);
    dimensions = element.geometricBounds;

    if (height) {
        element.geometricBounds = [dimensions[0], dimensions[1], dimensions[2] + height, dimensions[3] ];
    }

    dimensions = element.geometricBounds;


    if (spacingBottom) {
        element.geometricBounds = [dimensions[0], dimensions[1], dimensions[2] + spacingBottom, dimensions[3] ];
    }

}

function getText(fullText, type) {

    // var partial = fullText.split('*' + type + '*').pop().split("\n")[0] || 'unknown';
    var partial = fullText.split('*' + type + '*').pop().split('*/' + type + '*')[0] || 'unknown';
    return partial;
}
   
